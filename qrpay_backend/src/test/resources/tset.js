<%@page import="com.bccard.mpm.common.util.StringUtil"%>
<%@page import="org.slf4j.Logger, org.slf4j.LoggerFactory"%>
<%@page import="com.nshc.NFilter"%>
<%!
        Logger _logger = LoggerFactory.getLogger("com.bccard.mpm");

        public String getUserAgent( HttpServletRequest request) {

               String _userAgent = request.getHeader("user-agent");

               if( _userAgent.toUpperCase().indexOf("ANDROID") > -1){
                       _userAgent = "A";
               }
               else if(_userAgent.toUpperCase().indexOf("IPHONE") > -1 ||  _userAgent.toUpperCase().indexOf("IPAD") > -1){
                       _userAgent = "I";
               }
               else {
                       _userAgent = "";
               }

               return _userAgent;
        }

        public boolean setNFilterKeySession( HttpServletRequest request) {

               boolean isGenKey = false;

               if( AppConfig.getAppPropertyBoolean("nFilter.enable", true) ){

                       try {

                              HttpSession session = request.getSession();

                              if( session.getAttribute("nFilter_publicKey") == null || session.getAttribute("nFilter_PrivateKey") == null ){

                                      _logger.debug("================ $$ nFilter key generate $$ =============");

                                      NFilter nfilter = new NFilter();
                                      byte[][] ecckeypair = nfilter.GenerateKeypair();

                                      session.setAttribute("nFilter_publicKey", nfilter.Base64Encode( ecckeypair[0] ));
                                      session.setAttribute("nFilter_PrivateKey", nfilter.Base64Encode( ecckeypair[1] ));

                                      _logger.debug("nFilter_version : " + nfilter.getVersion());

                                      isGenKey = true;
                              }
                              else {
                                      _logger.debug("================ ## nFilter key already generated ## =============");
                              }

                              _logger.debug("nFilter_publicKey : " + session.getAttribute("nFilter_publicKey"));
                              _logger.debug("nFilter_PrivateKey : " + session.getAttribute("nFilter_PrivateKey"));

                       } catch(Exception e) {
                              _logger.error("nFilter key generate error.", e);
                       }
               }

               return isGenKey;
        }

        public String getSendNFilterPublicKeyScript( HttpServletRequest request) {

               String sendScript = "";

               if( AppConfig.getAppPropertyBoolean("nFilter.enable", true) ){

                       String publicKey = (String)request.getSession().getAttribute("nFilter_publicKey");
                       String userAgent = getUserAgent( request);

                       if( publicKey == null || publicKey.isEmpty()) {
                              setNFilterKeySession( request);
                       }

                       if( userAgent.equals("A")) {
                              sendScript = "window.android.nfilter(\"" + StringUtil.nvl3( request.getSession().getAttribute("nFilter_publicKey"), "") + "\");";
                       }
                       else if( userAgent.equals("I")) {
                              sendScript = "location.href=\"appto://nfilter?publicKey=" + StringUtil.nvl3( request.getSession().getAttribute("nFilter_publicKey"), "") + "\";";
                       }

                       _logger.debug("getSendNFilterPublicKeyScript : " + sendScript);
               }

               return sendScript;
        }
%>

<script type="text/javascript">
        <% // [MODE : eng, num ], [NAME : fieldname], [len : 글자 최대 길이], [desc : title] %>
        function showNFilterKeypad( mode, name, len, desc) {

               <%
               // 단말에 nFilter publicKey 전달
               out.println( getSendNFilterPublicKeyScript( request));
               %>

               var _userAgent = "<%=getUserAgent( request)%>";

               setTimeout(function(){
                       if( _userAgent == "A") {
                       window.android.showNFilterKeypad(mode, name, len, desc);
                       }
                       else if( _userAgent == "I") {
                              location.href = "appto://showNFilterKeypad?mode="+mode+"&name="+name+"&len="+len+"&desc="+desc+"&upYn=Y";

                       }
               }, 10);
        }

        function showNFilterKeypadDown( mode, name, len, desc) {

               <%
               // 단말에 nFilter publicKey 전달
               out.println( getSendNFilterPublicKeyScript( request));
               %>

               var _userAgent = "<%=getUserAgent( request)%>";
               setTimeout(function(){
                       if( _userAgent == "A") {
                              window.android.showNFilterKeypad(mode, name, len, desc);
                       }
                       else if( _userAgent == "I") {
                              location.href = "appto://showNFilterKeypad?mode="+mode+"&name="+name+"&len="+len+"&desc="+desc+"&upYn=N";
                       }
               }, 10 );
        }

        var loginType = "";
        <% // nFilter CALLBACK (암호화값, 필드네임, 쓰레기값) %>
        function showNFilterKeypadCallBack( encData, name, dummyData) {
               $("#"+name).val( encData);
               $("#"+name.replace("_ENCRYPT", "")).val( dummyData);
               if( window.location.href.indexOf("OauthLogin.api") == -1) {
                       var dumLength = dummyData.length;
                       if(name.indexOf("_RENEW_") == -1){
                              $("#"+name.replace("_ENCRYPT", "")).css("background-image", "url('"+ pwdImgArr2[dumLength].src +"')");
                       } else { <%-- 이름에  _RENEW_가 있으면 신버전 UI 동작을 화면으로 넘김--%>
                              if($.isFunction(nFilterUiUpdate)){
                                      nFilterUiUpdate(name);
                              }
                       }
               } else {
                       // simple login nfilter
                       if(loginType == "2"){
                              var dumLength = dummyData.length;
                              //$(this).css("background-image", "url('"+ pwdImgArr[keyLen].src +"')");
                              //$("#"+name.replace("_ENCRYPT", "")).css("background-image", "url('"+ pwdImgArr[dumLength].src +"')");
                              for(var i = 1; i <= 6 ;i++ ){
                                      if( dumLength > 0 && i <= dumLength){
                                              $("#"+name.replace("_ENCRYPT", "_"+i)).addClass("active");
                                      } else {
                                              $("#"+name.replace("_ENCRYPT", "_"+i)).removeClass("active");
                                      }
                              }
                              if($.isFunction(nFilterUiUpdate)){
                                      nFilterUiUpdate(name);
                              }
                       } else { <%//신규 뱔견 특이 케이스  mainLogin%>
                              if($.isFunction(nFilterUiUpdate)){
                                      nFilterUiUpdate(name);
                              }
                       }
               }

               <% /* 모든 비밀번호 입력 시 6자리가 체워지면 키보드 숨김이 동작하도록 -2019-09-18 신동욱 계장 확인.   */ %>
               if( dummyData.length == 6 ){
                       hideNFilterKeypad();
               }
        }

        var nFilterCloseState = "InitHide";
        <%-- 키보드 숨김 함수 패스워드 6자리 입력 후 바로 호출 할 함수 --%>
        function hideNFilterKeypad() {
               nFilterCloseState = "CallHide";
               var _userAgent = "<%=getUserAgent( request)%>";

               if( _userAgent == "A") {

                       window.android.hideNFilterKeypad();
               }
               else if( _userAgent == "I") {
                       location.href = "appto://hideNFilterKeypad2";
               }
        }

        <%-- hideNFilterKeypad 함수로 키보드를 닫았으면 폰에서 정상적으로 닫았다는 것을 알려 주는 함수 --%>
        function hideNFilterKeypadCallBack(){
               <% // APP 에서 정상적으로 닫힌 경우
                       //기본적으로 closeNFilterKeypadCallBack와 같은 동작을 수행하지만 스테이트 세팅값은 다름   %>

               console.log("call : hideNFilterKeypadCallBack");
               try {
                       if(nFilterCloseState == "CallHide"){ //닫힐떄 2번 불리는 현상이 있어서 중복 호출 방지용
                              if( (window.location.href.indexOf("OauthLogin.api") > -1)
                                              && (typeof login).toUpperCase() == "FUNCTION") {
                                      setTimeout(function(){login();}, 100);
                              }else if(window.location.href.indexOf("MerInfoUpd.do") > -1){
                                      fnDone();
                              }else {
                                      if($.isFunction(nFilterClose)){
                                              nFilterClose();
                                      }
                              }
                       }
               }
               catch(e) {
               }
               nFilterCloseState = "DoneHide";
        }
        <% // nFilter close CALLBACK %>
        function closeNFilterKeypadCallBack() {
               console.log("call : closeNFilterKeypadCallBack");
               try {
                       if(nFilterCloseState != "DoneHide"){ //닫힐떄 2번 불리는 현상이 있어서 중복 호출 방지용
                              if( (window.location.href.indexOf("OauthLogin.api") > -1)
                                              && (typeof login).toUpperCase() == "FUNCTION") {
                                      setTimeout(function(){login();}, 100);
                              }else if(window.location.href.indexOf("MerInfoUpd.do") > -1){
                                      fnDone();
                              }else {
                                      if($.isFunction(nFilterClose)){
                                              nFilterClose();
                                      }
                              }
                       }
               }
               catch(e) {
               }
               nFilterCloseState = "InitHide";
        }
        <% // nFilter 화면 스크롤 이 필요한 경우 %>
        function nFilterScrollLink(nFilterType, nFilterEncField, nFilterLength, nFilterMessage, bodyHeaderId){
               var pos = $("#"+nFilterEncField.replace("_ENCRYPT", "")).offset();
               $('html, body').animate({scrollTop : pos.top*0.5},400);
               showNFilterKeypad(nFilterType, nFilterEncField, nFilterLength, nFilterMessage);
        }


</script>