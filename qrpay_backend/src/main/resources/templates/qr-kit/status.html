<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>BC</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <script src="/js/jquery-3.3.1.slim.min.js.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <link href="/css/common.css" rel="stylesheet" />
    <script src="/js/common.js"></script>
    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'local')}">
      <script th:src="@{/js/qrpay_sdk.dev.js}"></script>
    </th:block>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'dev')}">
      <script th:src="@{/js/qrpay_sdk.dev.js}"></script>
    </th:block>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'prod')}">
      <script th:src="@{/js/qrpay_sdk.prod.js}"></script>
    </th:block>
  </head>

  <body>
    <div id="wrap">
      <header id="hd">
        <div class="container">
          <button type="button" class="icon-back" onclick="goBack()">이전 페이지 이동</button>
          <h1>배송조회</h1>
          <a class="icon-home" href="javascript:void(0)" onclick="goHome()">홈으로 이동</a>
        </div>
      </header>

      <div id="state-qrkit-status-loading" style="display: none">
        <div id="ct" class="container">
          <h2 class="h401 mt60">신청 내역을 불러오는 중입니다.<br /><br />데이터 조회가 길어질 경우 BC QR결제 가맹점 상담센터(<span class="fc-blue">02-330-5777</span>)을 이용해주세요.</h2>
          <a href="javascript:void(0)" onclick="pageMove(PAGES_APIS.PAGES_QRKIT_APPLY)" class="btn btn-primary btn-lg btn-block mt50">QR키트 신청하기</a>
        </div>
      </div>

      <div id="state-qrkit-status-noData" style="display: none">
        <div id="ct" class="container">
          <h2 class="h401 mt60">QR키트를 신청하지 않았습니다.<br />QR키트를 신청하시겠습니까?</h2>
          <a href="javascript:void(0)" onclick="pageMove(PAGES_APIS.PAGES_QRKIT_APPLY)" class="btn btn-primary btn-lg btn-block mt50">QR키트 신청하기</a>
        </div>
      </div>

      <div id="state-qrkit-status-error" style="display: none">
        <div id="ct" class="container">
          <h2 class="h401 mt60">QR키트 신청조회시 오류가 발생하였습니다.<br /><br />BC QR결제 가맹점 상담센터(<span class="fc-blue">02-330-5777</span>)을 이용해주세요.</h2>
          <a href="javascript:void(0)" onclick="pageMove(PAGES_APIS.PAGES_QRKIT_APPLY)" class="btn btn-primary btn-lg btn-block mt50">QR키트 신청하기</a>
        </div>
      </div>

      <div id="state-qrkit-status-list" style="display: none">
        <div id="ct" class="deliv-srch-wrap">
          <div class="info-cont">
            <h2 class="tit01">신청정보</h2>
            <div id="qrkit-history-container">
              <ul class="list-info" id="qrkit-apply-list"></ul>
            </div>
            <!-- <ul class="list-info">
              <li>
                00.00.00에 신청한<br />
                QR키트는 <span class="flag-red">신청완료</span> 상태입니다.
              </li>
              <li>
                00.00.00에 신청한<br />
                QR키트는 <span class="flag-blue">제작&middot;배송 준비중</span> 상태입니다.
              </li>
              <li>
                00.00.00에 신청한<br />
                QR키트는 <span class="flag-green">발송완료</span> 상태입니다.<br />
                &rarr; 등기번호 : <span class="uline">000000000000</span>
              </li>
            </ul> -->
          </div>
          <div class="notice-cont">
            <h2 class="tit01">안내사항</h2>
            <ul class="lst-type-bull">
              <li>발송완료 이후 배송 진행 상황은 우체국 사이트에서 확인해주세요. <strong>등기번호</strong>를 확인해주세요.</li>
              <li>QR키트를 수령하지 못하셨나요?<br />BC QR결제 가맹점 상담센터(<span class="fc-blue">02-330-5777</span>)을 이용해주세요.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div th:replace="~{fragments/modals/common-modal :: passwordContent}"></div>
    <div th:replace="~{fragments/modals/common-modal :: confirmModal}"></div>
    <div th:replace="~{fragments/modals/common-modal :: loadingModal}"></div>
  </body>
  <script>
    const QRKIT_STATUS = {
      LOADING: 'loading',
      NODATA: 'noData',
      ERROR: 'error',
      LIST: 'list',
    };

    const qrKitStatusManager = {
      state: {
        status: '', // loading, noData, error, list
        qrkitlist: [],
      },

      setState: function (newState) {
        this.state = { ...this.state, ...newState };
        this.render();
      },

      init: function () {
        this.setState({ status: QRKIT_STATUS.LOADING, qrkitlist: [] });
        this.fetchData();

        const mockData = [
          { merchantId: 'M1234567890', applicationAt: '20231001', shippingStatus: 'APPLIED', registeredMailNo: null },
          { merchantId: 'M1234567890', applicationAt: '20231015', shippingStatus: 'PREPARING', registeredMailNo: null },
          { merchantId: 'M1234567890', applicationAt: '20231020', shippingStatus: 'SHIPPED', registeredMailNo: '1234567890123' },
          // {merchantId:'M1234567890', applicationAt:'20231025', shippingStatus:'SHIPPED', registeredMailNo:null},
        ];
        /*
        window.setTimeout(() => {
          this.setState({ status: QRKIT_STATUS.LIST, qrkitlist: mockData });
        }, 1000);*/
      },

      render: function () {
        if (this.state.status === QRKIT_STATUS.LOADING) {
          document.getElementById('state-qrkit-status-loading').style.display = 'none';
          document.getElementById('state-qrkit-status-noData').style.display = 'none';
          document.getElementById('state-qrkit-status-error').style.display = 'none';
          document.getElementById('state-qrkit-status-list').style.display = 'none';
        } else if (this.state.status === QRKIT_STATUS.NODATA) {
          document.getElementById('state-qrkit-status-loading').style.display = 'none';
          document.getElementById('state-qrkit-status-noData').style.display = 'block';
          document.getElementById('state-qrkit-status-error').style.display = 'none';
          document.getElementById('state-qrkit-status-list').style.display = 'none';
        } else if (this.state.status === QRKIT_STATUS.ERROR) {
          document.getElementById('state-qrkit-status-loading').style.display = 'none';
          document.getElementById('state-qrkit-status-noData').style.display = 'none';
          document.getElementById('state-qrkit-status-error').style.display = 'block';
          document.getElementById('state-qrkit-status-list').style.display = 'none';
        } else if (this.state.status === QRKIT_STATUS.LIST) {
          document.getElementById('state-qrkit-status-loading').style.display = 'none';
          document.getElementById('state-qrkit-status-noData').style.display = 'none';
          document.getElementById('state-qrkit-status-error').style.display = 'none';
          document.getElementById('state-qrkit-status-list').style.display = 'block';
          this.renderQrKitHistory(this.state.qrkitlist);
        }
      },

      renderQrKitHistory: (dataList) => {
        const listElement = document.getElementById('qrkit-apply-list');

        // 기존 내용 삭제
        listElement.innerHTML = '';

        if (!dataList || dataList.length === 0) {
          listElement.innerHTML = '<li class="text-center">신청 내역이 없습니다.</li>';
          return;
        }

        dataList.forEach((item) => {
          const li = document.createElement('li');

          // 1. 상태값에 따른 플래그 설정
          let flagClass = '';
          let statusName = item.shippingStatus; // 기본값

          // Enum 명칭에 따른 분기 (자바 QrKitShippingStatus 기준)
          if (item.shippingStatus === 'APPLIED') {
            // 신청완료
            flagClass = 'flag-red';
            statusName = '신청완료';
          } else if (item.shippingStatus === 'PREPARING') {
            // 제작·배송 준비중
            flagClass = 'flag-blue';
            statusName = '제작·배송 준비중';
          } else if (item.shippingStatus === 'SHIPPED') {
            // 발송완료
            flagClass = 'flag-green';
            statusName = '발송완료';
          }

          // 2. 날짜 포맷팅 (YYYY.MM.DD)
          const formattedDate = formatDate(item.applicationAt);

          // 3. HTML 조립
          let html = `
            ${formattedDate}에 신청한<br />
            QR키트는 <span class="${flagClass}">${statusName}</span> 상태입니다.
        `;

          // 4. 발송완료 시 등기번호 추가
          if (item.shippingStatus === 'SHIPPED' && item.registeredMailNo) {
            html += `<br />&rarr; 등기번호 : <span class="uline">${item.registeredMailNo}</span>`;
          }

          li.innerHTML = html;
          listElement.appendChild(li);
        });
      },

      fetchData: async function () {
        const url = REST_APIS.QR_KIT.STATUS;
        console.log(url);

        const data = await qrpaySdk.fetchGetAsync(url);
        console.log(JSON.stringify(data));
        if (data.ok) {
          const { applications } = data.data;
          if (applications && applications.length > 0) {
            this.setState({ status: QRKIT_STATUS.LIST, qrkitlist: applications });
          } else {
            this.setState({ status: QRKIT_STATUS.NODATA, qrkitlist: [] });
          }
        } else {
          const status = data.status;
          if (status === 401) {
            console.log('로그인이 필요합니다.', JSON.stringify(data));
            const auth_loginId = this.state.authLoginId || '';
            PasswordModal.open({
              loginId: auth_loginId,
              onSuccessCallback: (res) => {
                fetchData();
              },
              onCancelCallback: () => {
                console.log('cancel authentication');
              },
            });
          } else {
            this.setState({ status: QRKIT_STATUS.ERROR, qrkitlist: [] });
          }
        }
      },
    };

    /** 날짜 포맷팅 유틸 함수 */
    function formatDate(dateStr) {
      if (!dateStr) return '00.00.00';
      // API 날짜 형식이 20231025라면 23.10.25로 변환
      const d = dateStr.replace(/[^0-9]/g, '');
      if (d.length >= 8) {
        return `${d.substring(2, 4)}.${d.substring(4, 6)}.${d.substring(6, 8)}`;
      }
      return dateStr;
    }

    document.addEventListener('DOMContentLoaded', function () {
      qrKitStatusManager.init();
    });
  </script>

  <script></script>
</html>
