<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>BC</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <script src="/js/jquery-3.3.1.slim.min.js.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <link href="/css/common.css" rel="stylesheet" />
    <script src="/js/common.js"></script>
    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'local')}">
      <script th:src="@{/js/qrpay_sdk.dev.js}"></script>
    </th:block>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'dev')}">
      <script th:src="@{/js/qrpay_sdk.dev.js}"></script>
    </th:block>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'prod')}">
      <script th:src="@{/js/qrpay_sdk.prod.js}"></script>
    </th:block>
  </head>

  <body>
    <div id="wrap">
      <!-- header -->
      <header id="hd">
        <div class="container">
          <button type="button" class="icon-back" onclick="goLogin()">이전 페이지 이동</button>
          <h1>비밀번호 찾기 - 아이디 입력</h1>
          <a class="icon-home" href="javascript:void(0)" onclick="goHome()">홈으로 이동</a>
        </div>
      </header>

      <!-- container -->
      <div id="ct">
        <!-- 페이지 시작 -->
        <div class="cnt-btm-wrp">
          <ol class="lst-step-circle">
            <li class="active">1단계</li>
            <li>2단계</li>
            <li>3단계</li>
          </ol>
          <div class="container">
            <div class="frm pt50">
              <div class="form-group">
                <span class="tit">아이디</span>
                <input id="input-findpw-id" type="text" class="form-control" placeholder="아이디를 입력해 주세요" maxlength="18" />
              </div>
            </div>
          </div>

          <div class="btm-fixed-btn">
            <button id="btn-findpw-next" class="btn btn-muted btn-block" onclick="debouncedCheckId();">다음</button>
            <!--		<a class="btn btn-primary btn-block" href="#">다음</a> 활성화-->
          </div>
        </div>
      </div>
    </div>
    <div th:replace="~{fragments/modals/common-modal :: passwordContent}"></div>
    <div th:replace="~{fragments/modals/common-modal :: confirmModal}"></div>
    <div th:replace="~{fragments/modals/common-modal :: loadingModal}"></div>
  </body>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const idInput = document.getElementById('input-findpw-id');
      const nextBtn = document.getElementById('btn-findpw-next');

      idInput.addEventListener('input', function () {
        const idValue = idInput.value.trim(); // 공백 제거 후 값 확인

        if (idValue.length >= 4) {
          // 4자 이상일 때: 활성화
          nextBtn.classList.remove('btn-muted');
          nextBtn.classList.add('btn-primary');
          nextBtn.disabled = false;
        } else {
          // 4자 미만일 때: 비활성화 상태 유지
          nextBtn.classList.remove('btn-primary');
          nextBtn.classList.add('btn-muted');
          nextBtn.disabled = true;
        }
      });
    });

    const checkIdDuplication = async () => {
      const idInput = document.getElementById('input-findpw-id');
      let reqIdDupCheck = {
        id: idInput.value.trim(),
      };
      const data = await qrpaySdk.fetchPostAsync(REST_APIS.MEMBER.ID_DUP_CHECK, reqIdDupCheck);
      console.log(data);

      if (!data.ok) {
        const status = data.status;
        if (status === 409) {
          //정상 case
          const authId = idInput.value.trim();
          const params = new URLSearchParams({ authId: authId });
          const url = PAGES_APIS.PAGES_FINDPW_AUTH_METHOD + '?' + params.toString();
          pageMove(url);
          return;
        } else {
          const errorMsg = data || data.message || 'System Error';
          ConfirmModal.open({
            desc: '' + errorMsg,
            hideCancel: true,
          });
        }
      } else {
        ConfirmModal.open({
          title: '',
          desc: 'ID가 존재하지 않습니다.',
          hideCancel: true,
        });
      }
    };
    const debouncedCheckId = qr_throttleLeading(checkIdDuplication, 500);
  </script>
</html>
