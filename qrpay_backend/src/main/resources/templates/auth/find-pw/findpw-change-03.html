<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>BC</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <script src="/js/jquery-3.3.1.slim.min.js.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <link href="/css/common.css" rel="stylesheet" />
    <script src="/js/common.js"></script>
    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'local')}">
      <script th:src="@{/js/qrpay_sdk.dev.js}"></script>
    </th:block>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'dev')}">
      <script th:src="@{/js/qrpay_sdk.dev.js}"></script>
    </th:block>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'prod')}">
      <script th:src="@{/js/qrpay_sdk.prod.js}"></script>
    </th:block>
  </head>

  <body>
    <div id="wrap">
      <!-- header -->
      <header id="hd">
        <div class="container">
          <button type="button" class="icon-back" onclick="pageMove(PAGES_APIS.PAGES_FINDPW_CHECK_ID)">이전 페이지 이동</button>
          <h1>비밀번호 찾기 - 비밀번호 변경</h1>
          <a class="icon-home" href="javascript:void(0)" onclick="goHome()">홈으로 이동</a>
        </div>
      </header>

      <!-- container -->
      <div id="ct">
        <!-- 페이지 시작 -->
        <div class="cnt-btm-wrp">
          <ol class="lst-step-circle">
            <li>1단계</li>
            <li>2단계</li>
            <li class="active">3단계</li>
          </ol>
          <div class="container">
            <div class="frm pt50">
              <div class="form-group">
                <span class="tit">비밀번호</span>
                <input id="input-emp-pw" type="password" class="form-control" placeholder="숫자 6자리" maxlength="6" />
                <small class="form-text text-muted fw300">
                  <span id="pw-rule-six">v 6자리</span>
                  <span id="pw-rule-sequencial">v 동일/연속 3자리 이상 입력불가</span>
                </small>
              </div>
              <div class="form-group">
                <span class="tit">비밀번호 확인</span>
                <input id="input-emp-pw-confirm" type="password" class="form-control" placeholder="숫자 6자리" maxlength="6" />
                <small id="pw-mismatch-msg" class="form-text text-danger fw300" style="display: none"> 비밀번호가 일치하지 않습니다 </small>
              </div>
            </div>
          </div>

          <div class="btm-fixed-btn">
            <button id="btn-pw-reset" class="btn btn-muted btn-block" onclick="">완료</button>
            <!--		<a class="btn btn-primary btn-block" href="#">완료</a> 활성화-->
          </div>
        </div>
        <!--// 페이지 끝 -->
      </div>
    </div>
    <div th:replace="~{fragments/modals/common-modal :: passwordContent}"></div>
    <div th:replace="~{fragments/modals/common-modal :: confirmModal}"></div>
    <div th:replace="~{fragments/modals/common-modal :: loadingModal}"></div>
  </body>
  <script th:inline="javascript">
    const niceSmsRefId = /*[[${smsRefId}]]*/ '';

    const pwInput = document.getElementById('input-emp-pw');
    const ruleSix = document.getElementById('pw-rule-six');
    const ruleSeq = document.getElementById('pw-rule-sequencial');
    pwInput.addEventListener('input', function () {
      const val = this.value;

      // 1. 6자리 체크 (정확히 6자리 숫자)
      const isSix = /^\d{6}$/.test(val);
      updateStatus(ruleSix, isSix);

      // 2. 동일/연속 3자리 체크
      const isNoSequence = checkSequence(val);
      // 값이 있을 때만 체크 (빈 값일 때는 기본 상태)
      updateStatus(ruleSeq, val.length > 0 ? isNoSequence : false);
      checkFormValidity();
    });

    // 상태 업데이트 함수 (클래스 교체)
    function updateStatus(element, isValid) {
      if (isValid) {
        element.classList.add('text-success');
        element.classList.remove('text-danger', 'text-muted');
      } else {
        element.classList.add('text-danger');
        element.classList.remove('text-success', 'text-muted');
      }
    }

    // 동일/연속 문자 검사 로직
    function checkSequence(str) {
      if (str.length < 3) return true; // 3자리 미만은 일단 통과

      for (let i = 0; i < str.length - 2; i++) {
        const c1 = str.charCodeAt(i);
        const c2 = str.charCodeAt(i + 1);
        const c3 = str.charCodeAt(i + 2);

        // 동일 문자 3개 (예: 111, aaa)
        if (c1 === c2 && c2 === c3) return false;

        // 연속 숫자/문자 (예: 123, abc 또는 321, cba)
        if ((c1 + 1 === c2 && c2 + 1 === c3) || (c1 - 1 === c2 && c2 - 1 === c3)) {
          return false;
        }
      }
      return true;
    }

    // 요소 가져오기
    const confirmPwInput = document.getElementById('input-emp-pw-confirm'); // 비번 확인
    const mismatchMsg = document.getElementById('pw-mismatch-msg');

    confirmPwInput.addEventListener('input', function () {
      const originVal = pwInput.value;
      const confirmVal = this.value;

      // 1. 6글자가 입력되었는지 확인
      if (confirmVal.length === 6) {
        // 2. 원본과 일치하는지 비교
        if (originVal !== confirmVal) {
          // 일치하지 않으면 메시지 표시
          mismatchMsg.style.display = 'block';
        } else {
          // 일치하면 메시지 숨김
          mismatchMsg.style.display = 'none';
        }
      } else {
        // 3. 6글자가 아니면(지웠을 때 포함) 무조건 메시지 숨김
        mismatchMsg.style.display = 'none';
      }
      checkFormValidity();
    });

    // 버튼 요소 가져오기
    const btnPwReset = document.getElementById('btn-pw-reset');

    // 전체 폼 유효성 체크 함수
    function checkFormValidity() {
      const val = pwInput.value;
      const confirmVal = confirmPwInput.value;

      // 1. 비밀번호 6자리 숫자 여부
      const isSix = /^\d{6}$/.test(val);
      // 2. 동일/연속 3자리 체크
      const isNoSequence = checkSequence(val);
      // 3. 비밀번호 확인 일치 여부
      const isMatch = val.length === 6 && val === confirmVal;

      // 모든 조건 만족 시 버튼 활성화
      if (isSix && isNoSequence && isMatch) {
        btnPwReset.disabled = false;
        btnPwReset.classList.remove('btn-muted');
        btnPwReset.classList.add('btn-primary'); // 활성화 시 파란색 버튼으로 변경
        btnPwReset.onclick = pwReset; // 클릭 이벤트 연결
      } else {
        btnPwReset.disabled = true;
        btnPwReset.classList.add('btn-muted');
        btnPwReset.classList.remove('btn-primary');
        btnPwReset.onclick = null; // 클릭 이벤트 해제
      }
    }

    const pwReset = async () => {
      let reqPwRest = {
        newPassword: pwInput.value.trim(),
        confirmPassword: confirmPwInput.value.trim(),
        smsRefId: niceSmsRefId,
      };
      const data = await qrpaySdk.fetchPostAsync(REST_APIS.OPEN.PW_RESET, reqPwRest);
      console.log(data);

      if (!data.ok) {
        const errorMsg = data.error.message || '시스템오류';
        ConfirmModal.open({
          desc: '비밀번호 재설정에 실패하였습니다[' + errorMsg + ']',
          hideCancel: true,
        });
      } else {
        ConfirmModal.open({
          desc: '비밀번호 재설정이 완료되었습니다. 로그인 페이지로 이동합니다.',
          hideCancel: true,
          onConfirm: () => {
            pageMove(PAGES_APIS.PAGES_LOGIN);
          },
        });
      }
    };
  </script>
</html>
