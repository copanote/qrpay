<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>BC</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <script src="/js/jquery-3.3.1.slim.min.js.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <link href="/css/common.css" rel="stylesheet" />
    <script src="/js/common.js"></script>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'local')}">
      <script th:src="@{/js/qrpay_sdk.dev.js}"></script>
    </th:block>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'dev')}">
      <script th:src="@{/js/qrpay_sdk.dev.js}"></script>
    </th:block>

    <th:block th:if="${#arrays.contains(@environment.getActiveProfiles(), 'prod')}">
      <script th:src="@{/js/qrpay_sdk.prod.js}"></script>
    </th:block>
  </head>

  <body>
    <div id="wrap">
      <!-- header -->
      <header id="hd">
        <div class="container">
          <button type="button" class="icon-back" onclick="goBack()">ì´ì „ í˜ì´ì§€ ì´ë™</button>
          <h1>ì¶”ê°€ ì‚¬ìš©ì ì‹ ê·œë“±ë¡</h1>
          <a class="icon-home" href="javascript:void(0)" onclick="goHome()">í™ˆìœ¼ë¡œ ì´ë™</a>
        </div>
      </header>

      <!-- container -->
      <div id="ct">
        <!-- í˜ì´ì§€ ì‹œì‘ -->
        <div class="cnt-btm-wrp type2">
          <div class="container">
            <div class="frm mt25 mb25">
              <div class="form-group">
                <span class="tit">ì•„ì´ë””</span>
                <div class="pr">
                  <input id="input-id" type="text" maxlength="12" class="form-control pr60" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" />
                  <button type="button" class="btn-pos-right" onclick="checkIdDuplication()">ì¤‘ë³µí™•ì¸</button>
                </div>
                <small id="id-rule-msg" class="form-text text-muted fw300">4~12ìë¦¬ì˜ ì˜ë¬¸/ìˆ«ì/ì˜ë¬¸+ìˆ«ì ì¡°í•©</small>
              </div>
              <div class="form-group">
                <span class="tit">ë¹„ë°€ë²ˆí˜¸</span>
                <input id="input-emp-pw" type="password" class="form-control" placeholder="ìˆ«ì 6ìë¦¬" maxlength="6" />
                <small class="form-text text-muted fw300">
                  <span id="pw-rule-six">v 6ìë¦¬</span>
                  <span id="pw-rule-sequencial">v ë™ì¼/ì—°ì† 3ìë¦¬ ì´ìƒ ì…ë ¥ë¶ˆê°€</span>
                </small>
              </div>
              <div class="form-group">
                <span class="tit">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</span>
                <input id="input-emp-pw-confirm" type="password" class="form-control" placeholder="ìˆ«ì 6ìë¦¬" maxlength="6" />
                <small id="pw-mismatch-msg" class="form-text text-danger fw300" style="display: none"> ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ </small>
              </div>
            </div>
            <p class="btm-border mt30">ê¶Œí•œ ë¶€ì—¬</p>
            <ul class="lst-btm-border mt10">
              <li class="row align-items-center">
                <div class="col">ìŠ¹ì¸ì·¨ì†Œ ê¶Œí•œ <button type="button" class="icon-help ml5">ë„ì›€ë§</button></div>
                <div class="col-xs-auto">
                  <label class="switch-chk"> <input id="permission-cancel" type="checkbox" checked /><i></i> </label>
                </div>
              </li>
            </ul>
          </div>
          <div class="btm-fixed-btn type2">
            <button id="btn-add-emp" class="btn btn-primary btn-block" onclick="addEmployee()" disabled>í™•ì¸</button>
          </div>
        </div>
        <!--// í˜ì´ì§€ ë -->
      </div>
      <div th:replace="~{fragments/modals/common-modal :: passwordContent}"></div>
      <div th:replace="~{fragments/modals/common-modal :: confirmModal}"></div>
      <div th:replace="~{fragments/modals/common-modal :: loadingModal}"></div>
    </div>
    <script>
      let passedIdRule = false;
      const idInput = document.getElementById('input-id');
      const idRuleMsg = document.getElementById('id-rule-msg');
      const addEmpBtn = document.getElementById('btn-add-emp');

      idInput.addEventListener('input', function () {
        const val = this.value;

        //  ì •ê·œì‹ ì„¤ëª…:
        // ^[a-zA-Z0-9] : ì˜ë¬¸ ëŒ€ì†Œë¬¸ì ë˜ëŠ” ìˆ«ìë¡œ ì‹œì‘
        // {4,12} : ìµœì†Œ 4ì, ìµœëŒ€ 12ì
        const idRegex = /^[a-zA-Z0-9]{4,12}$/;

        const isIdValid = idRegex.test(val);

        // ğŸ¯ isIdValidê°€ trueë©´ disabledë¥¼ í•´ì œ(false), falseë©´ ì„¤ì •(true)

        if (val.length === 0) {
          // ê°’ì´ ì—†ì„ ë•ŒëŠ” ê¸°ë³¸ íšŒìƒ‰(text-muted)ìœ¼ë¡œ ì´ˆê¸°í™”
          idRuleMsg.className = 'form-text text-muted fw300';
          passedIdRule = false;
        } else if (isIdValid) {
          // ì¡°ê±´ì— ë§ì„ ë•Œ (ì´ˆë¡ìƒ‰)
          idRuleMsg.classList.add('text-success');
          idRuleMsg.classList.remove('text-danger', 'text-muted');
          passedIdRule = true;
        } else {
          // ì¡°ê±´ì— ë§ì§€ ì•Šì„ ë•Œ (ë¹¨ê°„ìƒ‰)
          idRuleMsg.classList.add('text-danger');
          idRuleMsg.classList.remove('text-success', 'text-muted');
          passedIdRule = false;
        }
      });

      const checkIdDuplication = async () => {
        if (!passedIdRule) {
          alert('ì•„ì´ë””ëŠ” ì˜ë¬¸, ìˆ«ì, ì˜ë¬¸+ìˆ«ì í˜¼í•© 4~12ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        let reqIdDupCheck = {
          id: idInput.value,
        };
        const data = await qrpaySdk.fetchPostAsync(REST_APIS.MEMBER.ID_DUP_CHECK, reqIdDupCheck);
        console.log(data);
        if (!data.ok) {
          addEmpBtn.disabled = true;
          const status = data.status;
          if (status === 401) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            PasswordModal.open({
              loginId: '',
              onSuccessCallback: function (res) {
                checkIdDuplication();
              },
              onCancelCallback: function () {
                console.log('cancel authentication');
              },
            });
            return;
          } else if (status === 409) {
            const errorMsg = 'ë™ì¼ IDê°€ ì¡´ì¬í•©ë‹ˆë‹¤';
            alert(errorMsg);
          } else {
            const errorMsg = data || data.message || 'ë™ì¼ IDê°€ ì¡´ì¬í•©ë‹ˆë‹¤';
            alert(errorMsg);
          }
        } else {
          addEmpBtn.disabled = false;
          alert('ë“±ë¡ê°€ëŠ¥í•œ IDì…ë‹ˆë‹¤');
        }
      };

      const pwInput = document.getElementById('input-emp-pw');
      const ruleSix = document.getElementById('pw-rule-six');
      const ruleSeq = document.getElementById('pw-rule-sequencial');
      pwInput.addEventListener('input', function () {
        const val = this.value;

        // 1. 6ìë¦¬ ì²´í¬ (ì •í™•íˆ 6ìë¦¬ ìˆ«ì)
        const isSix = /^\d{6}$/.test(val);
        updateStatus(ruleSix, isSix);

        // 2. ë™ì¼/ì—°ì† 3ìë¦¬ ì²´í¬
        const isNoSequence = checkSequence(val);
        // ê°’ì´ ìˆì„ ë•Œë§Œ ì²´í¬ (ë¹ˆ ê°’ì¼ ë•ŒëŠ” ê¸°ë³¸ ìƒíƒœ)
        updateStatus(ruleSeq, val.length > 0 ? isNoSequence : false);
      });

      // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í´ë˜ìŠ¤ êµì²´)
      function updateStatus(element, isValid) {
        if (isValid) {
          element.classList.add('text-success');
          element.classList.remove('text-danger', 'text-muted');
        } else {
          element.classList.add('text-danger');
          element.classList.remove('text-success', 'text-muted');
        }
      }

      // ë™ì¼/ì—°ì† ë¬¸ì ê²€ì‚¬ ë¡œì§
      function checkSequence(str) {
        if (str.length < 3) return true; // 3ìë¦¬ ë¯¸ë§Œì€ ì¼ë‹¨ í†µê³¼

        for (let i = 0; i < str.length - 2; i++) {
          const c1 = str.charCodeAt(i);
          const c2 = str.charCodeAt(i + 1);
          const c3 = str.charCodeAt(i + 2);

          // ë™ì¼ ë¬¸ì 3ê°œ (ì˜ˆ: 111, aaa)
          if (c1 === c2 && c2 === c3) return false;

          // ì—°ì† ìˆ«ì/ë¬¸ì (ì˜ˆ: 123, abc ë˜ëŠ” 321, cba)
          if ((c1 + 1 === c2 && c2 + 1 === c3) || (c1 - 1 === c2 && c2 - 1 === c3)) {
            return false;
          }
        }
        return true;
      }

      // ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const confirmPwInput = document.getElementById('input-emp-pw-confirm'); // ë¹„ë²ˆ í™•ì¸
      const mismatchMsg = document.getElementById('pw-mismatch-msg');

      confirmPwInput.addEventListener('input', function () {
        const originVal = pwInput.value;
        const confirmVal = this.value;

        // 1. 6ê¸€ìê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (confirmVal.length === 6) {
          // 2. ì›ë³¸ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ë¹„êµ
          if (originVal !== confirmVal) {
            // ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
            mismatchMsg.style.display = 'block';
          } else {
            // ì¼ì¹˜í•˜ë©´ ë©”ì‹œì§€ ìˆ¨ê¹€
            mismatchMsg.style.display = 'none';
          }
        } else {
          // 3. 6ê¸€ìê°€ ì•„ë‹ˆë©´(ì§€ì› ì„ ë•Œ í¬í•¨) ë¬´ì¡°ê±´ ë©”ì‹œì§€ ìˆ¨ê¹€
          mismatchMsg.style.display = 'none';
        }
      });

      const addEmployee = async () => {
        const permissions_array = document.getElementById('permission-cancel').checked ? ['cancel'] : [];

        let reqAddEmployee = {
          loginId: idInput.value,
          password: pwInput.value,
          confirmPassword: confirmPwInput.value,
          permissions: permissions_array,
        };

        const data = await qrpaySdk.fetchPostAsync(REST_APIS.MERCHANT.ADD_EMPLOYEES, reqAddEmployee);
        console.log(data);
        if (!data.ok) {
          const status = data.status;
          if (status === 401) {
            PasswordModal.open({
              loginId: '',
              onSuccessCallback: function (res) {
                addEmployee();
              },
              onCancelCallback: function () {
                console.log('cancel authentication');
              },
            });
            return;
          } else {
            const errorMsg = data || data.message || 'ì‹œìŠ¤í…œì˜¤ë¥˜';
            alert('ì¶”ê°€ ì‚¬ìš©ì ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤[' + errorMsg + ']');
          }
        } else {
          pageMove(PAGES_APIS.PAGES_EMPLOYEE_LIST);
        }
      };

      window.addEventListener('pageshow', (event) => {
        idInput.value = '';
        pwInput.value = '';
        confirmPwInput.value = '';
        document.getElementById('permission-cancel').checked = true;
        addEmpBtn.disabled = true;
      });
    </script>
  </body>
</html>
